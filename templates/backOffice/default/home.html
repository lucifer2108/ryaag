{extends file="admin-layout.tpl"}

{block name="no-return-functions"}
    {$admin_current_location = 'home'}
{/block}

{block name="page-title"}{intl l='Back-office home'}{/block}

{block name="main-content"}
    <div class="homepage">
        <div id="wrapper" class="container">

            {hook name="home.top" location="home_top" }

            {* Do not display shop information block if user none of the required authorizations *}

            {capture name="shop_information_block_content"}
                {loop type="auth" name="can_view" role="ADMIN" resource="admin.customer" access="VIEW"}
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="customer" current="false" backend_context="1"}</h2>
                        <p>{intl l="Customers"}</p>
                    </div>
                {/loop}

                {loop type="auth" name="can_view" role="ADMIN" resource="admin.category" access="VIEW"}
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="category" visible="*" backend_context="1"}</h2>
                        <p>{intl l="Categories"}</p>
                    </div>
                {/loop}

                {loop type="auth" name="can_view" role="ADMIN" resource="admin.product" access="VIEW"}
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="product" visible="*" backend_context="1"}</h2>
                        <p>{intl l="Products"}</p>
                    </div>
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="product" visible="true" backend_context="1"}</h2>
                        <p>{intl l="Online products"}</p>
                    </div>
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="product" visible="false" backend_context="1"}</h2>
                        <p>{intl l="Offline products"}</p>
                    </div>
                {/loop}

                {loop type="auth" name="can_view" role="ADMIN" resource="admin.order" access="VIEW"}
                    <div class="stats col-md-2 col-xs-4">
                        <h2>{count type="order" status="*" customer="*" backend_context="1"}</h2>
                        <p>{intl l="Orders"}</p>
                    </div>
                {/loop}
            {/capture}

            {if trim($smarty.capture.shop_information_block_content) ne ""}
                <div class="general-block-decorator">
                    <div class="row">
                        {$smarty.capture.shop_information_block_content nofilter}
                    </div>
                </div>
            {/if}

            {loop type="auth" name="can_view" role="ADMIN" resource="admin.order" access="VIEW"}
                <div class="general-block-decorator dashboard">

                    <div class="title title-without-tabs clearfix">
                        {intl l='Dashboard'}
                        <div class="btn-group pull-right">
                            <button type="button" class="btn btn-default js-stats-change-month" data-month-offset="0"><span class="glyphicon glyphicon-refresh"></span></button>
                            <button type="button" class="btn btn-default js-stats-change-month" data-month-offset="-1"><span class="glyphicon glyphicon-chevron-left"></span></button>
                            <button type="button" class="btn btn-default" disabled><span class="glyphicon glyphicon-calendar"></span></button>
                            <button type="button" class="btn btn-default js-stats-change-month" data-month-offset="+1"><span class="glyphicon glyphicon-chevron-right"></span></button>
                        </div>
                    </div>

                    <div class="text-center clearfix">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default active" data-toggle="jqplot" data-target="sales"><span class="glyphicon glyphicon-euro"></span> {intl l="Sales"}</button>
                            <button type="button" class="btn btn-primary" data-toggle="jqplot" data-target="registration"><span class="glyphicon glyphicon-user"></span> {intl l="New customers"}</button>
                            <button type="button" class="btn btn-success" data-toggle="jqplot" data-target="orders"><span class="glyphicon glyphicon-shopping-cart"></span> {intl l="Orders"}</button>
                            <button type="button" class="btn btn-info" data-toggle="jqplot" data-target="first-orders"><span class="glyphicon glyphicon-thumbs-up"></span> {intl l="First orders"}</button>
                            <button type="button" class="btn btn-danger" data-toggle="jqplot" data-target="aborted-orders"><span class="glyphicon glyphicon-thumbs-down"></span> {intl l="Aborted orders"}</button>
                        </div>
                    </div>

                    <hr/>

                    <div class="jqplot-content">
                        <div id="jqplot"></div>
                    </div>

                </div>
            {/loop}

            <div class="row">
                {loop type="auth" name="can_view" role="ADMIN" resource="admin.order" access="VIEW"}
                    <div class="col-md-4">
                        <div class="general-block-decorator">
                            <div class="title title-without-tabs">{intl l="Sales statistics"}</div>

                            <ul class="nav nav-tabs nav-justified">
                                <li class="active"><a href="#statjour" data-toggle="tab">{intl l="Today"}</a></li>
                                <li><a href="#statmois" data-toggle="tab">{intl l="This month"}</a></li>
                                <li><a href="#statannee" data-toggle="tab">{intl l="This year"}</a></li>
                            </ul>

                            {capture assign=defaultCurrency}
                                {loop type="currency" name="default-currency" default_only="1"}
                                {$SYMBOL}
                                {/loop}
                            {/capture}

                            <div class="tab-content">
                                <div class="tab-pane fade active in" id="statjour">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <tbody>
                                            <tr>
                                                <th>{intl l="Overall sales"}</th>
                                                <td>{stats key="sales" startDate="today" endDate="today"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Sales excluding shipping"}</th>
                                                <td>
                                                    {$salesNoShipping = {stats key="sales" startDate="today" endDate="today" includeShipping="false"}}
                                                    {$salesNoShipping} {$defaultCurrency}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Yesterday sales"}</th>
                                                <td>{stats key="sales" startDate="yesterday" endDate="yesterday"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Orders"}</th>
                                                <td>
                                                    {$orderCount =  {stats key="orders" startDate="today" endDate="today"}}
                                                    {$orderCount}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Average cart"}</th>
                                                <td>
                                                    {if $orderCount == 0}
                                                        0 {$defaultCurrency}
                                                    {else}
                                                        {($salesNoShipping/$orderCount)|round:"2"} {$defaultCurrency}
                                                    {/if}
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="statmois">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <tbody>
                                            <tr>
                                                <th>{intl l="Overall sales"}</th>
                                                <td>{stats key="sales" startDate="this_month" endDate="this_month"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Sales excluding shipping"}</th>
                                                <td>
                                                    {$salesNoShipping = {stats key="sales" startDate="this_month" endDate="this_month" includeShipping="false"}}
                                                    {$salesNoShipping} {$defaultCurrency}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Previous month sales"}</th>
                                                <td>{stats key="sales" startDate="last_month" endDate="last_month"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Orders"}</th>
                                                <td>
                                                    {$orderCount =  {stats key="orders" startDate="this_month" endDate="this_month"}}
                                                    {$orderCount}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Average cart"}</th>
                                                <td>
                                                    {if $orderCount == 0}
                                                        0 {$defaultCurrency}
                                                    {else}
                                                        {($salesNoShipping/$orderCount)|round:"2"} {$defaultCurrency}
                                                    {/if}
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="statannee">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <tbody>
                                            <tr>
                                                <th>{intl l="Overall sales"}</th>
                                                <td>{stats key="sales" startDate="this_year" endDate="this_year"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Sales excluding shipping"}</th>
                                                <td>
                                                    {$salesNoShipping = {stats key="sales" startDate="this_year" endDate="this_year" includeShipping="false"}}
                                                    {$salesNoShipping} {$defaultCurrency}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Previous year sales"}</th>
                                                <td>{stats key="sales" startDate="last_year" endDate="last_year"} {$defaultCurrency}</td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Orders"}</th>
                                                <td>
                                                    {$orderCount =  {stats key="orders" startDate="this_year" endDate="this_year"}}
                                                    {$orderCount}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{intl l="Average cart"}</th>
                                                <td>
                                                    {if $orderCount == 0}
                                                        0 {$defaultCurrency}
                                                    {else}
                                                        {($salesNoShipping/$orderCount)|round:"2"} {$defaultCurrency}
                                                    {/if}
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {/loop}

                <div class="col-md-4">
                    <div class="feed-list">
                        <div class="alert alert-info">{intl l="Loading Thelia lastest news..."}</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="general-block-decorator">
                        <div class="title title-without-tabs">{intl l="Thelia informations"}</div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                <tr>
                                    <th>{intl l="Current version"}</th>
                                    <td>{$THELIA_VERSION}</td>
                                </tr>
                                <tr>
                                    <th>{intl l="Latest version available"}</th>
                                    <td><a href="http://thelia.net/#download" id="latest-thelia-version">{intl l="Loading..."}</a></td>
                                </tr>
                                <tr>
                                    <th>{intl l="News"}</th>
                                    <td><a href="http://thelia.net/blog" target="_blank">{intl l="Click here"}</a></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {hookblock name="home.block" fields="id,title,content"}
                {forhook rel="home.block"}
                    <div class="col-md-4">
                        <div {if $id}id="{$id}"{/if} class="general-block-decorator">
                            {if $title}<div class="title title-without-tabs">{$title}</div>{/if}
                            {$content}
                        </div>
                    </div>
                {/forhook}
                {/hookblock}
            </div>

            {hook name="home.bottom" location="home_bottom"}
        </div>
    </div>
{/block}

{block name="javascript-initialization"}

    {javascripts file='assets/js/jqplot/jquery.jqplot.min.js'}
        <script src="{$asset_url}"></script>
    {/javascripts}
    {javascripts file='assets/js/jqplot/plugins/jqplot.highlighter.min.js'}
        <script type="text/javascript" src="{$asset_url}"></script>
    {/javascripts}
    {javascripts file='assets/js/jqplot/plugins/jqplot.barRenderer.min.js'}
        <script type="text/javascript" src="{$asset_url}"></script>
    {/javascripts}
    {javascripts file='assets/js/jqplot/plugins/jqplot.pieRenderer.min.js'}
        <script type="text/javascript" src="{$asset_url}"></script>
    {/javascripts}

    <script>

        jQuery(function($){

            $(".feed-list").load("{admin_viewurl view='ajax/thelia_news_feed'}");

            var jQplotDate = new Date();
            jQplotDate.setDate(1); // Set day to 1 so we can add month without 30/31 days of month troubles.
            var url = "{url path='/admin/home/stats'}";
            var jQplotData; // json data
            var jQPlotInstance; // global instance

            var jQPlotsOptions = {
                animate: true,
                axesDefaults: {
                    tickOptions: { showMark: true, showGridline: true }
                },
                axes: {
                    xaxis: {
                        borderColor: '#ccc',
                        ticks : [],
                        tickOptions:    { showGridline: false }
                    },
                    yaxis: {
                        tickOptions: { showGridline: true, showMark: false, showLabel: false, shadow: false }
                    }
                },
                seriesDefaults: {
                    lineWidth: 3,
                    shadow : false,
                    markerOptions: { shadow : false, style: 'filledCircle', size: 12 }
                },
                grid: {
                    background: '#FFF',
                    shadow : false,
                    borderColor : '#FFF'
                },
                highlighter: {
                    show: true,
                    sizeAdjust: 7,
                    tooltipLocation: 'n',
                    tooltipContentEditor: function(str, seriesIndex, pointIndex, plot){

                        // Return axis value : data value
                        //return jQPlotsOptions.axes.xaxis.ticks[pointIndex][1] + ': ' + plot.data[seriesIndex][pointIndex][1];
                        return plot.data[seriesIndex][pointIndex][1];
                    }
                }
            };

            {literal}

            // Get initial data Json
            retrieveJQPlotJson(jQplotDate.getMonth()+1, jQplotDate.getFullYear());

            $('[data-toggle="jqplot"]').click(function(){

                $(this).toggleClass('active');
                jsonSuccessLoad();

            });

            $('.js-stats-change-month').click(function(e){
                $('.js-stats-change-month').attr('disabled', true);

                var flush = 0, move = parseInt($(this).data('month-offset'));

                if (move !== 0) {
                    jQplotDate.setMonth(parseInt(jQplotDate.getMonth()) + move);
                } else {
                    flush = 1;
                }

                retrieveJQPlotJson(
                        jQplotDate.getMonth()+1,
                        jQplotDate.getFullYear(),
                        function(){$('.js-stats-change-month').attr('disabled', false);},
                        flush
                );
            });

            function retrieveJQPlotJson(month, year, callback, flush) {

                if (typeof flush === "undefined") {
                    flush = 0;
                }

                $.getJSON(url, {month: month, year: year, flush: flush})
                        .done(function(data) {
                            jQplotData = data;
                            jsonSuccessLoad();
                            if(callback) {
                                callback();
                            }
                        })
                        .fail(jsonFailLoad);
            }

            function initJqplotData(json) {
                var series = [];
                var seriesColors = [];
                $('[data-toggle="jqplot"].active').each(function(i){
                    var position = $(this).index();
                    series.push(json.series[position].data);
                    seriesColors.push(json.series[position].color);
                });

                // Number of days to display ( = data.length in one serie)
                var days = json.series[0].data.length;

                // Add days to xaxis
                var ticks = [];
                for(var i = 1; i < (days+1); i++){
                    ticks.push([i-1, i]);
                }
                jQPlotsOptions.axes.xaxis.ticks = ticks;

                // Graph title
                jQPlotsOptions.title = json.title;

                // Graph series colors
                jQPlotsOptions.seriesColors = seriesColors;

                return series;
            }

            function jsonFailLoad(data) {
                $('#jqplot').html('<div class="alert alert-danger">An error occurred while reading from JSON file</div>');
            }

            function jsonSuccessLoad() {

                // Init jQPlot
                var series = initJqplotData(jQplotData);

                // Start jQPlot
                if(jQPlotInstance) {
                    jQPlotInstance.destroy();
                }
                jQPlotInstance = $.jqplot("jqplot", series, jQPlotsOptions);

                $(window).bind('resize', function(event, ui) {
                    jQPlotInstance.replot( { resetAxes: true } );
                });

            }
            {/literal}

            // Get the latest Thelia version
            $.ajax({
                url: "http://thelia.net/version.php",
                beforeSend: function (jqXHR) {
                    jqXHR.setRequestHeader("Thelia-Version", "{$THELIA_VERSION}");
                },
                crossDomain: true
            }).done(function(data) {
                $('#latest-thelia-version').text(data);
            }).fail(function() {
                $('#latest-thelia-version').text("Unavailable");
            });

        });

    </script>
{/block}

{block name="javascript-last-call"}
    {hook name="home.js" location="home-js"}
{/block}