{extends file="admin-layout.tpl"}

{block name="no-return-functions"}
    {$admin_current_location = 'configuration'}
{/block}

{block name="page-title"}{intl l='Thelia Mailing Templates'}{/block}

{block name="check-resource"}admin.configuration.message{/block}
{block name="check-access"}view{/block}

{block name="main-content"}
<div class="messages">

    <div id="wrapper" class="container">

        <ul class="breadcrumb">
            <li><a href="{url path='/admin/home'}">{intl l="Home"}</a></li>
            <li><a href="{url path='/admin/configuration'}">{intl l="Configuration"}</a></li>
            <li><a href="{url path='/admin/configuration/messages'}">{intl l="Mailing templates"}</a></li>
        </ul>

        {module_include location='messages_top'}

        <div class="row">
            <div class="col-md-12">
                <form action="{url path='/admin/configuration/messages/update-values'}" method="post">
	                <div class="general-block-decorator">
                        <div class="table-responsive">
    	                    <table class="table table-striped table-condensed table-left-aligned">
    	                        <caption>
    	                           {intl l='Thelia mailing templates'}
    	                           {loop type="auth" name="can_create" role="ADMIN" resource="admin.configuration.message" access="CREATE"}
                                    <a class="btn btn-default btn-primary action-btn" title="{intl l='Add a new mailing template'}" href="#creation_dialog" data-toggle="modal">
                                        <span class="glyphicon glyphicon-plus-sign"></span>
                                    </a>
                                {/loop}

    	                        </caption>
                                <thead>
        	                        <tr>
        	                           <th>{intl l="Purpose"}</th>
                                       <th>{intl l="Name"}</th>

                                       {module_include location='messages_table_header'}

                                       <th>&nbsp;</th>
        	                        </tr>
                                </thead>

                                <tbody>
        	                        {loop name="mailing-templates" type="message" secured="*" backend_context="1" lang="$lang_id"}
        	                            <tr>

        	                               <td>{$TITLE}</td>

                                           <td>
                                           {if ! $SECURED}
                                               {loop type="auth" name="can_change" role="ADMIN" resource="admin.configuration.message" access="UPDATE"}
                                                   <a title="{intl l='Change this mailing template'}" href="{url path='/admin/configuration/messages/update' message_id="$ID"}">{$NAME}</a>
                                               {/loop}
                                               {elseloop rel="can_change"}
                                                   {$NAME}
                                               {/elseloop}
                                           {else}
                                               {$NAME}
                                           {/if}
                                           </td>

        	                                {module_include location='messages_table_row'}

        	                                <td class="actions">
        	                                    {if ! $SECURED}
        		                                    <div class="btn-group">
                                                       {loop type="auth" name="can_change" role="ADMIN" resource="admin.configuration.message" access="UPDATE"}
                                                           <a class="btn btn-default btn-xs message-change" title="{intl l='Change this mailing template'}" href="{url path='/admin/configuration/messages/update' message_id="$ID"}"><i class="glyphicon glyphicon-edit"></i></a>
                                                       {/loop}

                                                       {loop type="auth" name="can_delete" role="ADMIN" resource="admin.configuration.message" access="DELETE"}
                                                           <a class="btn btn-default btn-xs message-delete" title="{intl l='Delete this mailing template'}" href="#delete_dialog" data-id="{$ID}" data-toggle="modal"><i class="glyphicon glyphicon-trash"></i></a>
                                                       {/loop}
        		                                    </div>
        		                                {else}
        		                                    <i title="{intl l='This mailing template could not be changed.'}" class="glyphicon glyphicon-ban-circle"></i>
        	                                    {/if}
        	                                </td>
        	                            </tr>
        	                        {/loop}
        	                        {elseloop rel="mailing-templates"}
        	                        <tr>
        	                           <td colspan="3">
        	                               <div class="alert alert-info">
        	                               {intl l="No mailing template has been created yet. Click the + button to create one."}
        	                               </div>
        	                           </td>
        	                        </tr>
        	                        {/elseloop}
                                </tbody>
    	                    </table>
                        </div>
	                </div>
                </form>
            </div>
        </div>

        {module_include location='messages_bottom'}

    </div>
</div>


    {* Adding a new message *}


    {form name="thelia.admin.message.creation"}

        {* Capture the dialog body, to pass it to the generic dialog *}
        {capture "creation_dialog"}
		    {form_hidden_fields form=$form}

		    {form_field form=$form field='success_url'}
		    {* on success, redirect to the edition page, _ID_ is replaced with the created message ID, see controller  *}
		    <input type="hidden" name="{$name}" value="{url path='/admin/configuration/messages/update' message_id='_ID_'}" />
		    {/form_field}

		    {* We do not allow users to create secured messages from here *}

		    {form_field form=$form field='secured'}
		    <input type="hidden" name="{$name}" value="0" />
		    {/form_field}

	        {form_field form=$form field='name'}
	        <div class="form-group {if $error}has-error{/if}">
	            <label for="{$label_attr.for}" class="control-label">{$label}{if $required} <span class="required">*</span>{/if} : </label>
	            <input type="text" id="{$label_attr.for}" {if $required}required="required"{/if} name="{$name}" value="{$value}" title="{intl l='Mailing template name'}" placeholder="{intl l='Mailing template name'}" class="form-control">
	        </div>
	        {/form_field}

	        {form_field form=$form field='title'}
	        <div class="form-group {if $error}has-error{/if}">
	            <label for="{$label_attr.for}" class="control-label">{$label}{if $required} <span class="required">*</span>{/if} : </label>

	            {loop type="lang" name="default-lang" default_only="1"}

	                {* Switch edition to the current locale *}
	                <input type="hidden" name="edit_language_id" value="{$ID}" />

	                <div class="input-group">
	                    <input type="text" id="{$label_attr.for}" {if $required}required="required"{/if} name="{$name}" value="{$value}" title="{intl l='Mailing template purpose'}" placeholder="{intl l='Mailing template purpose'}" class="form-control">
	                    <span class="input-group-addon"><img src="{image file="assets/img/flags/{$CODE}.png"}" alt="{$TITLE}" /></span>
	                </div>

	                <div class="help-block">{intl l="Enter here the mailing template purpose in the default language (%title)" title={$TITLE}}</div>

	                {form_field form=$form field='locale'}
	                    <input type="hidden" name="{$name}" value="{$LOCALE}" />
	                {/form_field}
	            {/loop}

	        </div>
	        {/form_field}

            {module_include location='message_create_form'}

        {/capture}

        {include
            file = "includes/generic-create-dialog.html"

            dialog_id    = "creation_dialog"
            dialog_title = {intl l="Create a new mailing template"}
            dialog_body  = {$smarty.capture.creation_dialog nofilter}

            dialog_ok_label     = {intl l="Create this mailing template"}

            form_action        = {url path='/admin/configuration/messages/create'}
            form_enctype       = {form_enctype form=$form}
            form_error_message = $form_error_message
        }
    {/form}

    {* Delete confirmation dialog *}

    {capture "delete_dialog"}
        <input type="hidden" name="message_id" id="message_delete_id" value="" />

        {module_include location='message_delete_form'}

    {/capture}

    {include
        file = "includes/generic-confirm-dialog.html"

        dialog_id       = "delete_dialog"
        dialog_title    = {intl l="Delete mailing template"}
        dialog_message  = {intl l="Do you really want to delete this mailing template ?"}

        form_action         = {url path='/admin/configuration/messages/delete'}
        form_content        = {$smarty.capture.delete_dialog nofilter}
    }
{/block}

{block name="javascript-initialization"}
<script>
    $(function() {

    	// Set proper message ID in delete from
    	$('a.message-delete').click(function(ev) {
    		$('#message_delete_id').val($(this).data('id'));
     	});

        // JS stuff for creation form
        {include
            file      = "includes/generic-js-dialog.html"
            dialog_id = "creation_dialog"
            form_name = "thelia.admin.message.creation"
        }
    });
</script>
{/block}

{block name="javascript-last-call"}
    {module_include location='messages-js'}
{/block}